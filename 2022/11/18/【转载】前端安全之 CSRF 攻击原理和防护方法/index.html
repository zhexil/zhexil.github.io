<!DOCTYPE html>
<html lang="zh-CN">
  <head>
  <meta charset="UTF-8">
  <meta 
    name="viewport"
    content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <meta 
    http-equiv="X-UA-Compatible" 
    content="ie=edge">
  <meta 
    name="theme-color" 
    content="#fff" 
    id="theme-color">
  <meta 
    name="description" 
    content="掬捧，一盏清浅的缱绻时光 漫煮一壶清茶，品茗香 搁浅一份柔情蜜意 聆听，如诗如歌的往事 寥寥数语，丝丝波澜，却瘦尽流年">
  <link 
    rel="icon" 
    href="/">
  <title>【转载】前端安全之 CSRF 攻击原理和防护方法</title>
  
    
      <meta 
        property="og:title" 
        content="【转载】前端安全之 CSRF 攻击原理和防护方法">
    
    
      <meta 
        property="og:url" 
        content="https://zhexil.github.io/2022/11/18/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8%E4%B9%8B%20CSRF%20%E6%94%BB%E5%87%BB%E5%8E%9F%E7%90%86%E5%92%8C%E9%98%B2%E6%8A%A4%E6%96%B9%E6%B3%95/index.html">
    
    
      <meta 
        property="og:img" 
        content="https://img.songhn.com/img/Y67gdd.png">
    
    
      <meta 
        property="og:img" 
        content="掬捧，一盏清浅的缱绻时光 漫煮一壶清茶，品茗香 搁浅一份柔情蜜意 聆听，如诗如歌的往事 寥寥数语，丝丝波澜，却瘦尽流年">
    
    
      <meta 
        property="og:type" 
        content="article">
      <meta 
        property="og:article:published_time" 
        content="2022-11-18">
      <meta 
        property="og:article:modified_time" 
        content="2022-11-18">
      <meta 
        property="og:article:author" 
        content="苞粟玉米">
      
        
          <meta 
            property="og:article:tag" 
            content="CSRF">
        
      
    
  
  
  <link rel="preload" href="//at.alicdn.com/t/font_1946621_i1kgafibvw.css" as="style" >
  <link rel="preload" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css" as="style" >
  <link rel="preload" href="/css/main.css" as="style" >
  
  <link rel="modulepreload" href="//instant.page/5.1.0">
  
  <link rel="stylesheet" href="/css/main.css">
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1946621_i1kgafibvw.css">
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css">
  
  
  
    <link rel="stylesheet" href="/js/lib/lightbox/baguetteBox.min.css">
  
  <script>
    function loadScript(url, cb) {
      var script = document.createElement('script');
      script.src = url;
      if (cb) script.onload = cb;
      script.async = true;
      document.body.appendChild(script);
    }
    function loadCSS(href, data, attr) {
      var sheet = document.createElement('link');
      sheet.ref = 'stylesheet';
      sheet.href = href;
      sheet.dataset[data] = attr;
      document.head.appendChild(sheet);
    }
    function changeCSS(cssFile, data, attr) {
      var oldlink = document.querySelector(data);
      var newlink = document.createElement("link");
      newlink.setAttribute("rel", "stylesheet");
      newlink.setAttribute("href", cssFile);
      newlink.dataset.prism = attr;
      document.head.replaceChild(newlink, oldlink);
    }
  </script>
  
    
  
  <script>
    // control reverse button
    var reverseDarkList = {
      dark: 'light',
      light: 'dark'
    };
    var themeColor = {
      dark: '#1c1c1e',
      light: '#fff'
    }
    // get the data of css prefers-color-scheme
    var getCssMediaQuery = function() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };
    // reverse current darkmode setting function
    var reverseDarkModeSetting = function() {
      var setting = localStorage.getItem('user-color-scheme');
      if(reverseDarkList[setting]) {
        setting = reverseDarkList[setting];
      } else if(setting === null) {
        setting = reverseDarkList[getCssMediaQuery()];
      } else {
        return;
      }
      localStorage.setItem('user-color-scheme', setting);
      return setting;
    };
    // apply current darkmode setting
  </script>
  
    <script>
      var setDarkmode = function(mode) {
      var setting = mode || localStorage.getItem('user-color-scheme');
      if(setting === getCssMediaQuery()) {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[setting];
        document.getElementById('theme-color').dataset.mode = setting;
      } else if(reverseDarkList[setting]) {
        document.documentElement.setAttribute('data-user-color-scheme', setting);
        document.getElementById('theme-color').content = themeColor[setting];
        document.getElementById('theme-color').dataset.mode = setting;
      } else {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[getCssMediaQuery()];
        document.getElementById('theme-color').dataset.mode = getCssMediaQuery();
      }
    };
    setDarkmode();
    </script>
  
  
  
    <link rel="preload" href="/js/lib/lightbox/baguetteBox.min.js" as="script">
    <link rel="preload" href="/js/lib/lightbox/baguetteBox.min.css" as="style" >
  
  
    <link rel="preload" href="/js/lib/lozad.min.js" as="script">
  
  
  
  
    
    <link rel="prefetch" href="//cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-svg.js" as="script">
  
  
  
<meta name="generator" content="Hexo 6.3.0"></head>

  <body>
    <div class="wrapper">
       
      <nav class="navbar">
  <div class="navbar-logo">
    <a class="navbar-logo-main" href="/">
      
      <span class="navbar-logo-dsc">苞粟|玉米的博客</span>
      </a>
  </div>
  <div class="navbar-menu">
    
      <a 
        href="/" 
        class="navbar-menu-item">
        
          首页
        
      </a>
    
      <a 
        href="/archives" 
        class="navbar-menu-item">
        
          归档
        
      </a>
    
      <a 
        href="/tags" 
        class="navbar-menu-item">
        
          标签
        
      </a>
    
      <a 
        href="/categories" 
        class="navbar-menu-item">
        
          分类
        
      </a>
    
      <a 
        href="/about" 
        class="navbar-menu-item">
        
          关于
        
      </a>
    
      <a 
        href="/links" 
        class="navbar-menu-item">
        
          友链
        
      </a>
    
    <button 
      class="navbar-menu-item darknavbar navbar-menu-btn" 
      aria-label="Toggle dark mode"
      id="dark">
      <i class="iconfont icon-weather"></i>
    </button>
    <button 
      class="navbar-menu-item searchnavbar navbar-menu-btn" 
      aria-label="Toggle search"
      id="search">
      <!-- <i 
        class="iconfont icon-search" 
        style="font-size: 1.2rem; font-weight: 400;">
      </i> -->
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img"
        class="iconify iconify--ion" width="28" height="28" preserveAspectRatio="xMidYMid meet" viewBox="0 0 512 512">
        <path fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="28"
          d="M256 80a176 176 0 1 0 176 176A176 176 0 0 0 256 80Z"></path>
        <path fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="28"
          d="M232 160a72 72 0 1 0 72 72a72 72 0 0 0-72-72Z"></path>
        <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="28"
          d="M283.64 283.64L336 336"></path>
      </svg>
    </button>
  </div>
</nav> 
      
      <div 
        id="local-search" 
        style="display: none">
        <input
          class="navbar-menu-item"
          id="search-input"
          placeholder="请输入搜索内容..." />
        <div id="search-content"></div>
      </div>
      
      <div class="section-wrap">
        <div class="container">
          <div class="columns">
            <aside class="left-column">
              
              <div class="card card-author">
                
  <img 
    src="https://img.songhn.com/img/Y67gdd.png" 
    class="author-img"
    width="88"
    height="88"
    alt="author avatar">

<p class="author-name">苞粟玉米</p>
<p class="author-description">独隅一角，孤芳自赏</p>
<div class="author-message">
  <a 
    class="author-posts-count" 
    href="/archives">
    <span>6</span>
    <span>文章</span>
  </a>
  <a 
    class="author-categories-count" 
    href="/categories">
    <span>2</span>
    <span>分类</span>
  </a>
  <a 
    class="author-tags-count" 
    href="/tags">
    <span>4</span>
    <span>标签</span>
  </a>
</div>

              </div>
               <div class="sticky-tablet">
  
  
    <article class="display-when-two-columns spacer">
      <div class="card card-content toc-card">
        <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>目录
</div>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81CSRF-%E6%94%BB%E5%87%BB%E5%8E%9F%E7%90%86"><span class="toc-text">一、CSRF 攻击原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81Cookie-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">1、Cookie 的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81CSRF-%E7%9A%84%E6%94%BB%E5%87%BB%E8%BF%87%E7%A8%8B"><span class="toc-text">2、CSRF 的攻击过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E8%AF%BB%E6%93%8D%E4%BD%9C%E8%83%BD%E5%90%A6%E8%A2%AB%E6%94%BB%E5%87%BB%E5%88%B0%EF%BC%9F"><span class="toc-text">3、读操作能否被攻击到？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81CSRF-%E9%98%B2%E6%8A%A4%E6%96%B9%E6%B3%95"><span class="toc-text">二、CSRF 防护方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81Referrer"><span class="toc-text">1、Referrer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-Referrer-%E4%BC%9A%E4%B8%8D%E4%BC%9A%E8%A2%AB%E4%BC%AA%E9%80%A0%E6%88%96%E8%80%85%E7%AF%A1%E6%94%B9%EF%BC%9F"><span class="toc-text">1.1 Referrer 会不会被伪造或者篡改？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E7%94%A8-Referrer-%E9%98%B2-CSRF-%E5%AE%89%E5%85%A8%E4%B9%88%EF%BC%9F"><span class="toc-text">1.2 用 Referrer 防 CSRF 安全么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E7%94%A8-Origin-%E5%8F%AF%E4%BB%A5%E4%B9%88%EF%BC%9F"><span class="toc-text">1.3 用 Origin 可以么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E6%97%A2%E7%84%B6%E8%83%BD%E5%81%9A%E5%88%B0%E5%AE%89%E5%85%A8%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E7%8E%B0%E5%9C%A8%E5%BE%88%E5%B0%91%E8%A7%81%E7%94%A8%E8%BF%99%E7%A7%8D%E6%96%B9%E6%A1%88%EF%BC%9F"><span class="toc-text">1.4 既然能做到安全，为什么现在很少见用这种方案？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81Token"><span class="toc-text">2、Token</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Token-%E6%98%AF%E5%89%8D%E5%8F%B0%E7%94%9F%E4%BA%A7%E8%BF%98%E6%98%AF%E5%90%8E%E5%8F%B0%E7%94%9F%E4%BA%A7%EF%BC%9F"><span class="toc-text">2.1 Token 是前台生产还是后台生产？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%8E%A8%E8%8D%90%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%96%B9%E6%A1%88"><span class="toc-text">2.2 推荐的最佳实践方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-Token-%E6%94%BE%E5%9C%A8-HTTP-%E5%8F%82%E6%95%B0%E9%87%8C%E7%9A%84%E5%93%AA%E9%87%8C%EF%BC%9F"><span class="toc-text">2.3 Token 放在 HTTP 参数里的哪里？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E7%94%A8-Token-%E6%96%B9%E6%A1%88%E5%90%8E%E5%86%99%E6%93%8D%E4%BD%9C%E5%8F%AF%E4%BB%A5%E7%94%A8-Get-%E4%B9%88%EF%BC%9F"><span class="toc-text">2.4 用 Token 方案后写操作可以用 Get 么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E7%94%A8-Token-%E6%96%B9%E6%A1%88%E5%90%8E%E8%AF%BB%E6%93%8D%E4%BD%9C%E5%8F%AF%E4%BB%A5%E7%94%A8-JSONP-%E8%B7%A8%E5%9F%9F%E4%B9%88%EF%BC%9F"><span class="toc-text">2.5 用 Token 方案后读操作可以用 JSONP 跨域么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-%E5%A6%82%E6%9E%9C%E9%A1%B5%E9%9D%A2%E6%9C%89-XSS-%E6%BC%8F%E6%B4%9E%EF%BC%8C%E9%BB%91%E5%AE%A2%E6%8B%BF%E5%88%B0-Cookie-%E6%80%8E%E4%B9%88%E5%8A%9E%EF%BC%9F"><span class="toc-text">2.6 如果页面有 XSS 漏洞，黑客拿到 Cookie 怎么办？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%98%AF%E5%90%A6%E8%BF%98%E6%9C%89%E5%85%B6%E4%BB%96%E6%96%B9%E6%A1%88"><span class="toc-text">3、是否还有其他方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Cookie-%E7%9A%84-SameSite-%E5%B1%9E%E6%80%A7%E5%8F%AF%E4%BB%A5%E4%B9%88%EF%BC%9F"><span class="toc-text">3.1 Cookie 的 SameSite 属性可以么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Cookie-%E7%9A%84-HTTPOnly-%E5%B1%9E%E6%80%A7%E5%8F%AF%E4%BB%A5%E4%B9%88%EF%BC%9F"><span class="toc-text">3.2 Cookie 的 HTTPOnly 属性可以么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E9%AA%8C%E8%AF%81%E7%A0%81%E5%8F%AF%E4%BB%A5%E4%B9%88%EF%BC%9F"><span class="toc-text">3.3 验证码可以么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-HTTPS-%E5%8F%AF%E4%BB%A5%E4%B9%88%EF%BC%9F"><span class="toc-text">3.4 HTTPS 可以么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E4%B8%8D%E7%94%A8-Cookie-%E5%8F%AF%E4%BB%A5%E4%B9%88%EF%BC%9F"><span class="toc-text">3.5 不用 Cookie 可以么？</span></a></li></ol></li></ol>
      </div>
    </article>
  
  
  <article class="card card-content categories-widget">
    <div class="categories-card">
  <div class="categories-header">
    <i 
      class="iconfont icon-fenlei" 
      style="padding-right: 2px;">
    </i>分类
  </div>
  <div class="categories-list">
    
      <a href="/categories/%E5%89%8D%E7%AB%AF/">
        <div class="categories-list-item">
          前端
          <span class="categories-list-item-badge">2</span>
        </div>
      </a>
    
      <a href="/categories/%E8%AE%BE%E8%AE%A1/">
        <div class="categories-list-item">
          设计
          <span class="categories-list-item-badge">3</span>
        </div>
      </a>
    
  </div>
</div>
  </article>
  
  <article class="card card-content tags-widget">
    <div class="tags-card">
  <div class="tags-header">
    <i 
      class="iconfont icon-biaoqian" 
      style="padding-right: 2px;">
    </i>热门标签
  </div>
  <div class="tags-list">
    
      <a 
        href="/tags/%E9%85%8D%E8%89%B2/" 
        title="配色">
        <div class="tags-list-item">配色</div>
      </a>
    
      <a 
        href="/tags/CSRF/" 
        title="CSRF">
        <div class="tags-list-item">CSRF</div>
      </a>
    
      <a 
        href="/tags/%E7%BD%91%E7%AB%99/" 
        title="网站">
        <div class="tags-list-item">网站</div>
      </a>
    
      <a 
        href="/tags/hexo/" 
        title="hexo">
        <div class="tags-list-item">hexo</div>
      </a>
    
  </div>
</div>
  </article>
  
  
</div>
            </aside>
            <main class="main-column">
              
<article class="card card-content">
  <header>
    <h1 class="post-title">
      【转载】前端安全之 CSRF 攻击原理和防护方法
    </h1>
  </header>
  <div class="post-meta post-show-meta">
    <time datetime="2022-11-18T09:27:02.000Z">
      <i 
        class="iconfont icon-calendar" 
        style="margin-right: 2px;">
      </i>
      <span>2022-11-18</span>
    </time>
    
      <span class="dot"></span>
      
        <a 
          href="/categories/%E5%89%8D%E7%AB%AF/" 
          class="post-meta-link">
          前端
        </a>
      
    
    
      <span class="dot"></span>
      <span>5k 字</span>
    
  </div>
  
    <div 
      class="post-meta post-show-meta" 
      style="margin-top: -10px;">
      <div style="display: flex; align-items: center;">
        <i 
          class="iconfont icon-biaoqian" 
          style="margin-right: 2px; font-size: 1.15rem;">
        </i>
        
          
          <a 
            href="/tags/CSRF/" 
            class="post-meta-link">
            CSRF
          </a>
        
      </div>
    </div>
  
  </header>
  <div 
    id="section" 
    class="post-content">
    <p>作者：camdyzeng(曾健)，腾讯 CSIG 前端开发高级工程师</p>
<p>转载于：前端安全之 CSRF 攻击原理和防护方法 - 知乎  <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/522562168?utm_source=qq&amp;utm_medium=social&amp;utm_oi=1164833697126936576">https://zhuanlan.zhihu.com/p/522562168?utm_source=qq&amp;utm_medium=social&amp;utm_oi=1164833697126936576</a></p>
<blockquote>
<p>关于 CSRF 你想知道的都在这里了。</p>
</blockquote>
<p>CSRF(Cross-site request forgery)简称:跨站请求伪造，学习CSRF 攻击原理和防护方法是我们团队新成员的必修课，通常我都是先让新同学自己研究自己讲，然后我再通过其中细节再给他们讲一遍，讲的次数多了，也慢慢总结出一种比较容易理解的讲法。这里我整理成文分享给有需要的人。</p>
<p><strong>引言:必修课为什么选择CSRF?</strong></p>
<ol>
<li>CSRF涉及到的前端知识点比较多，全面理解需要系统的学习Cookie，前端跨域，HTTP协议,web浏览器等知识。</li>
<li>理解CSRF 攻击和防护方法是前端进阶要去，我也希望大家都能够掌握</li>
<li>个人兴趣，我个人对前端性能优化和前端安全比较感兴趣，也算参与和推动了公司内的 CSRF防护方案从无到有的过程。</li>
</ol>
<h2 id="一、CSRF-攻击原理"><a href="#一、CSRF-攻击原理" class="headerlink" title="一、CSRF 攻击原理"></a><strong>一、CSRF 攻击原理</strong></h2><h3 id="1、Cookie-的使用"><a href="#1、Cookie-的使用" class="headerlink" title="1、Cookie 的使用"></a><strong>1、Cookie 的使用</strong></h3><p>HTTP 是无状态协议，服务器只能根据当前请求的参数(包括 Head 和 Body 的数据)来判断本次请求需要达到的目的(Get 或者 Post 都一样)，服务器并不知道这个请求之前干了什么事，所以这就是无状态协议。</p>
<p>但是我们现实很多情况需要有状态，比如登录态的身份信息，网页上很多操作需要登录之后才能操作，比如相册的上传照片和删除照片等功能都需要登录之后才能操作。那么怎么判断登录态？(通常我会问如果你遇到这个问题你回怎么做？)，其实解决方案都是类似的，只能是每次 HTTP 请求都要把登录态信息(这里用 Key 表示)传给后台服务器，后台通过 Key 字段是判断用户合法性之后再处理这个请求要处理的敏感操作。</p>
<p>怎么方便的让每次 HTTP 请求都带上 Key？所以就设计出了 Cookie，这里列举 Cookie 主要的一些特性。</p>
<p><strong>1.1</strong> 浏览器默认自动携带本次 HTTP 请求域名的 Cookie（不管是通过什么方式，在什么页面发送的 HTTP 请求）。</p>
<p><strong>1.2</strong> 读写 Cookie 有跨域限制(作用域，Domain,Path)。</p>
<p><strong>1.3</strong> 生命周期(会话 or 持久)。</p>
<h3 id="2、CSRF-的攻击过程"><a href="#2、CSRF-的攻击过程" class="headerlink" title="2、CSRF 的攻击过程"></a><strong>2、CSRF 的攻击过程</strong></h3><p>根据上面介绍，登录态 Cookie 的 Key 是浏览器默认自动携带的，Key 通常是会话 Cookie，只要浏览器不关闭，Key 一直存在。所以只要用户 A 曾经登录过相册网站(这里用 <a href="https://link.zhihu.com/?target=http://www.photo.com">http://www.photo.com</a> 举例)，浏览器没有关闭，用户在没有关闭的浏览器打开一个黑客网页(这里用 <a href="https://link.zhihu.com/?target=http://www.hacker.com">http://www.hacker.com</a>)，黑客页面发送 HTTP 请求到 <a href="https://link.zhihu.com/?target=http://www.photo.com">http://www.photo.com</a> 的后台会默认带上 <a href="https://link.zhihu.com/?target=http://www.photo.com">http://www.photo.com</a> 的登录态 Cookie，也就能模拟用户 A 做一些增删改等敏感操作。Get 和 Post 都一样，这就是 CSRF 攻击原理。这种攻击过程也是最常见的攻击过程，后面还会介绍另外一种少见的攻击过程。</p>
<h3 id="3、读操作能否被攻击到？"><a href="#3、读操作能否被攻击到？" class="headerlink" title="3、读操作能否被攻击到？"></a><strong>3、读操作能否被攻击到？</strong></h3><p>上面说的增删改都是写操作，会对后台数据产生负面影响，所以是能被攻击的。另外一种读操作，是具有幂等性，不会对后台数据残生负面影响，能否被攻击到？读操作也可能是敏感数据，举个例子，比如<strong><a target="_blank" rel="noopener" href="http://www.photo.com/">www.photo.com</a></strong>上的私密相册数据能否被<strong><a target="_blank" rel="noopener" href="http://www.hacker.com/">www.hacker.com</a></strong>页面拿到？这就涉及到前端跨域知识点了，默认大部分情况是拿不到，这里列举两种特殊情是可以拿到的：</p>
<ul>
<li>如果后台返回的数据是 JSONP 格式的，这种只能是 Get 操作，是能被黑客页面拿到的。</li>
<li>如果后台是通过 CORS 处理跨域，没有对请求头的 Origin 做白名单限制，ACAO 响应头是*或者包括黑客页面，包括 Get&#x2F;Post&#x2F;Del 等操作，也是能被黑客页面拿到的。</li>
</ul>
<p>除了这两种特殊情况，读操作都是不能被攻击到的，因为浏览器跨域限制是天然的安全的。关于跨域知识细节，我写过另外一篇文章，没有发外网，暂时只是公司内能看，有兴趣的读者可以联系我(文章后有我联系方式)，我私下发给有需要的读者。</p>
<h2 id="二、CSRF-防护方法"><a href="#二、CSRF-防护方法" class="headerlink" title="二、CSRF 防护方法"></a><strong>二、CSRF 防护方法</strong></h2><p>知道攻击原理，防护方法也很简单，找到能够区分请求发送的页面是自己的页面还是黑客的页面的方法就可以了。</p>
<h3 id="1、Referrer"><a href="#1、Referrer" class="headerlink" title="1、Referrer"></a><strong>1、Referrer</strong></h3><p>HTTP 请求头 Referrer 字段是浏览器默认带上，含义是发送请求的页面地址，比如同样是删除相册的操作<a href="https://link.zhihu.com/?target=http://www.photo.com/del?id=xxx;">http://www.photo.com/del?id=xxx;</a>如果是从相册自己页面发送出来，Referrre的值是<a href="https://link.zhihu.com/?target=http://www.photo.com/index.html">http://www.photo.com/index.html</a>（以首页举例），如果是从黑客页面发送出来的Referrer的值是<a href="https://link.zhihu.com/?target=http://www.hacker.com/index.html">http://www.hacker.com/index.html</a>（以首页举例），所以后端只要通过Referrrer做白名单判断就能防这种常见的CSRF攻击。下面探讨几个容易被忽悠的问题。</p>
<h3 id="1-1-Referrer-会不会被伪造或者篡改？"><a href="#1-1-Referrer-会不会被伪造或者篡改？" class="headerlink" title="1.1 Referrer 会不会被伪造或者篡改？"></a><strong>1.1 Referrer 会不会被伪造或者篡改？</strong></h3><ul>
<li>在浏览器环境下，Referrer 是浏览器自己带上的，js 是改不了 Rerferrer，所以是不能被伪造和篡改的。</li>
<li>浏览器插件能改 Referrer 么？答案：能改，但是浏览器插件攻击不属于 CSRF 攻击范畴，如果用户浏览器都已经被安装了黑客插件了就有更方便的攻击方法，但是不可能在所有用户浏览器都安装上黑客的插件。</li>
<li>通过网关或者抓包修改 Referrer？答案：能改，这是中间人攻击，也不属于 CSRF 攻击范畴。防中间人攻击用 HTTPS。</li>
<li>黑客通过自己后台代理，请求发到黑客自己的后台，黑客后台修改 Referrer 再转发到相册后台，可以改么？可行么？答案：能改，但不可行，请求发送到黑客自己后台不会带上相册的 Cookie，登录态校验通不过，敏感操作做不了。</li>
</ul>
<h3 id="1-2-用-Referrer-防-CSRF-安全么？"><a href="#1-2-用-Referrer-防-CSRF-安全么？" class="headerlink" title="1.2 用 Referrer 防 CSRF 安全么？"></a><strong>1.2 用 Referrer 防 CSRF 安全么？</strong></h3><p>处理了下面几种特殊情况，用 Referrer 防 CSRF 是安全</p>
<p>读操作不能有上面提到提到的两种特殊情况，不能用 JSONP，CORS 要白名单，所以读操作是安全的。<br>写操作 Referrer 为空的时候不能放过，使用白名单机制，Referrer 在白名单内才放过。什么时候会为空？<br>地址栏直接输入 url 的时候，第一个请求 Referrer 为空，一般是 html 页面，这种读操作不用防 CSRF<br>使用 Referrer-Policy 策略设置 no-referrer 是，Referrer 为空，自己的页面不要这样设置，为了防黑客的页面设置了，所以为空的时候不能放过。<br>还有一些 iframe 的特殊使用(以前用来绕过图片防盗链的)也会导致 Referrer 为空，这些情况都不能放过过。</p>
<p>写操作不能用 Get，如果写操作可以用 Get，由于 Img 标签，A 标签能发 Get 请求。所以在一些 UGC 网站，比如用户写日志可以插入自定义图片，能插入自定义连接，图片 img 标签 src 或者 A 标签的 href 就指向写操作的 URL，这样只要打开这篇日志就会发送这个 Get 请求，或者点击了日志上的连接，就帮用户做了写操作。并且 Referrer 还是合法的。这就是一种少见的 CSRF 攻击过程，其实也是最早期的 CSRF 攻击。这种攻击一旦成功，很方便做成蠕虫病毒，危害性极大。</p>
<p><em>PS 有人觉得这种少见的攻击过程不算 CSRF，应该算 XSS，好像也有点道理，但是常规的防 XSS 的方法貌似不好防这种特殊情况，下面要讲的 CSRF 的 Token 的防护方式是能防这种特殊情况的。</em></p>
<h3 id="1-3-用-Origin-可以么？"><a href="#1-3-用-Origin-可以么？" class="headerlink" title="1.3 用 Origin 可以么？"></a><strong>1.3</strong> <strong>用 Origin 可以么？</strong></h3><p>可以，原理跟 Referrer 一样，Origin 请求头是 XHR2.0 里增加的，含义是发送请求页面的域名，主要目的是解决跨域问题。如果用来校验 CSRF 请求，就有一些细节要处理好，后台判断 Origin 时也要使用白名单，并且不能为空，不在白名单内的请求都直接返回失败，不能执行请求里的写操作(有一些 web server 是请求执行了，也返回了数据，只是没有配 ACAO 响应头，浏览器收不到，这种情况能限制跨域请求，但是不能防 CSRF 的写操作)。另外一种做法就是自定义 HTTP 请求头，把 HTTP 请求升级为复杂请求，这样在跨域的情况就会先发一个 Option 预检请求，预检请求通不过也就不会执行后面真实请求了。</p>
<h3 id="1-4-既然能做到安全，为什么现在很少见用这种方案？"><a href="#1-4-既然能做到安全，为什么现在很少见用这种方案？" class="headerlink" title="1.4 既然能做到安全，为什么现在很少见用这种方案？"></a><strong>1.4</strong> <strong>既然能做到安全，为什么现在很少见用这种方案？</strong></h3><p>因为有更简单的方案，就是下面要讲的 Token 方案。</p>
<h3 id="2、Token"><a href="#2、Token" class="headerlink" title="2、Token"></a><strong>2、Token</strong></h3><p>上面讲到 Cookie 的一些特性的第二条，读写 Cookie 有跨域限制(作用域，Domain,Path)，所以我们可以用这个特性来区分是自己页面还是黑客页面。只要页面能读（或者写）<strong><a target="_blank" rel="noopener" href="http://www.photo.com/">www.photo.com</a></strong>域名 Cookie,就证明是自己的页面。懂了原理，方案就很简单，比如服务器通过 cookie 下发一个 token，token 值是随机数，页面发请求的时候从 cookie 取出 token 通过 HTTP 请求参数传给后台，后台比对参数里的 token 和 cookie 里的 token 是否一致，如果一致就证明是自己页面发的请求，如果不一致就返回失败。<strong>防 CSRF 的方案就是这么简单，这种方法能够 100%防 CSRF</strong>，但是可能会有几个变种，下面探讨几种情况。</p>
<h3 id="2-1-Token-是前台生产还是后台生产？"><a href="#2-1-Token-是前台生产还是后台生产？" class="headerlink" title="2.1 Token 是前台生产还是后台生产？"></a><strong>2.1 Token 是前台生产还是后台生产？</strong></h3><p>我上面举例例子是后台生成传到前台的，大家发现其实后台并没有存这个 token，所以原理上前后台生成<strong>都可以</strong>，只要保证随机性。如果前端生成 token 然后写到 Cookie 里，然后 HTTP 请求参数也带上 token，后端逻辑一样比对参数里的 token 和 cookie 里的 token 是否一致，如果一致就证明是自己页面发的请求，如果不一致就返回失败。这就是 Cookie 读和写的差别，只要能读写自己域名的 Cookie 就是自己页面。</p>
<h3 id="2-2-推荐的最佳实践方案"><a href="#2-2-推荐的最佳实践方案" class="headerlink" title="2.2 推荐的最佳实践方案"></a><strong>2.2</strong> <strong>推荐的最佳实践方案</strong></h3><p>由于登录态已经下发了一个登录态 key，防 CSRF 的 token 就复用这个 key，由于登录态 key 比较重要，尽量少明文暴露，所以前端拿到 key 后做了一次 Hash 放到 http 请求参数里，后端通过同样的 Hash 算法对 Cookie 里的 key 做 Hash 后跟参数里的 token 比对是否一致，如果一致就证明是自己页面发的请求，如果不一致就返回失败。这里对 Hash 算法要求不高，简单高效就可以。</p>
<h3 id="2-3-Token-放在-HTTP-参数里的哪里？"><a href="#2-3-Token-放在-HTTP-参数里的哪里？" class="headerlink" title="2.3 Token 放在 HTTP 参数里的哪里？"></a><strong>2.3 Token 放在 HTTP 参数里的哪里？</strong></h3><p>放在 URL 的 querystring 里，Post 请求的 Data 里或者 HTTP 请求头里，这三种方式都可以，只是有一点点细微的差别，如果 querystring 里，可能会影响 Get 请求的缓存效果，因为重新登录之后 token 会变，url 也就变了，之前的缓存就失效了。如果放在 HTTP 请求头里，就需要使用 fetch 或者 XHR 发请求，这样会变成复杂请求，跨域时需要多一次 Option 预检请求，对性能多少有一点点影响。</p>
<h3 id="2-4-用-Token-方案后写操作可以用-Get-么？"><a href="#2-4-用-Token-方案后写操作可以用-Get-么？" class="headerlink" title="2.4 用 Token 方案后写操作可以用 Get 么？"></a><strong>2.4</strong> <strong>用 Token 方案后写操作可以用 Get 么？</strong></h3><p>可以，从安全角度考虑是可以的，用了 Token 之后，Get 和 Post 的安全等级是一样的，上面讨论的那种少见的 CSRF 攻击过程也攻击不到了。但是从语义化考虑建议 Get 是还是处理读操作方便理解。</p>
<h3 id="2-5-用-Token-方案后读操作可以用-JSONP-跨域么？"><a href="#2-5-用-Token-方案后读操作可以用-JSONP-跨域么？" class="headerlink" title="2.5 用 Token 方案后读操作可以用 JSONP 跨域么？"></a><strong>2.5</strong> <strong>用 Token 方案后读操作可以用 JSONP 跨域么？</strong></h3><p>可以，可以使用 JSONP 跨域了，另外如果使用 CORS 处理跨域，建议还是需要对请求头的 Origin 做白名单限制，防止不同子域名相互影响。</p>
<h3 id="2-6-如果页面有-XSS-漏洞，黑客拿到-Cookie-怎么办？"><a href="#2-6-如果页面有-XSS-漏洞，黑客拿到-Cookie-怎么办？" class="headerlink" title="2.6 如果页面有 XSS 漏洞，黑客拿到 Cookie 怎么办？"></a><strong>2.6</strong> <strong>如果页面有 XSS 漏洞，黑客拿到 Cookie 怎么办？</strong></h3><p>这个方法防不了 XSS，防 XSS 需要其他方法，比如 CSP,用户输入&#x2F;输出做转义等。</p>
<h3 id="3、是否还有其他方案"><a href="#3、是否还有其他方案" class="headerlink" title="3、是否还有其他方案"></a><strong>3、是否还有其他方案</strong></h3><h3 id="3-1-Cookie-的-SameSite-属性可以么？"><a href="#3-1-Cookie-的-SameSite-属性可以么？" class="headerlink" title="3.1 Cookie 的 SameSite 属性可以么？"></a><strong>3.1 Cookie 的 SameSite 属性可以么？</strong></h3><p>不好用，SameSite 设计的目的貌似就是防 CSRF，但是我觉得不好用，SameSite 有三个值 Strict&#x2F;Lax&#x2F;None，设置的太严格，会影响自己业务的体验，设置的太松没有效果，就算最严格 Strict 模式，也防不了我上面提到写操作用 Get 请求，UGC 页面有自定义照片的情况。并且还有小部分老浏览器不支持，最终其实还是 Token 方案好用。</p>
<h3 id="3-2-Cookie-的-HTTPOnly-属性可以么？"><a href="#3-2-Cookie-的-HTTPOnly-属性可以么？" class="headerlink" title="3.2 Cookie 的 HTTPOnly 属性可以么？"></a><strong>3.2 Cookie 的 HTTPOnly 属性可以么？</strong></h3><p>不行，HTTPOnly 表示这个 Cookie 只能是 HTTP 请求可以读写，js 没有读写权限，浏览器还是会默认带上，所以登录态校验是通过的。如果设置了 HTTPOnly 还有副作用，上面说的 Token 方案就用不了了。</p>
<h3 id="3-3-验证码可以么？"><a href="#3-3-验证码可以么？" class="headerlink" title="3.3 验证码可以么？"></a><strong>3.3</strong> <strong>验证码可以么？</strong></h3><p>不行，验证码是用来防机器暴力攻击的，验证码是用来确认敏感操作是自然人发送还是机器自动发送。这里举个图片验证码的例子，大概原理是前端通过 img 标签展示图片验证码给用户看(图片字母经过噪音处理的)，这个图片 HTTP 请求也会设置一个 cookie 如 codeID&#x3D;xxx(加密的),用户在输入框输入图片中展示的字母，敏感操作的 HTTP 请求通过参数把用户输入的 code 传给后台，后台拿到用户输入的 code 和 cookie 里的 codeID(通常需要通过 id 查数据库)做比较，如果一致就通过。这种验证码系统能够防机器攻击，但是防不了 CSRF，黑客同样可以在黑客的页面展示验证码给用户，通过诱导用户输入验证码完成攻击操作，只能是提高了 CSRF 攻击成功的门槛，但是只要黑客页面诱导信息劲爆还是有很大部分用户会上当的。因为用户不知道输入验证码后会产生什么影响。</p>
<p>验证码我在一些资料上看到说可以用来防 CSRF，我个人觉得是不行，包括手机验证码都不行，详细情况大家可以研究各种验证码的实现原理。我猜测有些人可能有不同意见，但是如果非要构造一种能防 CSRF 的验证码技术上也是可行的。我这里推演一下防护过程。就拿我上面举得验证码举例。验证码图片的 url 是固定格式的<a href="https://link.zhihu.com/?target=http://code.photo.com/codeImg.jpg?v=123">http://code.photo.com/codeImg.jpg?v=123</a>。v是随机数，换一张时防止缓存用的。验证码每次请求会种一个Cookie,codeID&#x3D;xxx,后台会存储这个codeID对应的真实code，用户输入图片看到验证码，要校验验证码的请求参数会带上用户输入的code，后台拿到参数code和Cookie里的CodeID查数据库后对比来判断是否输入正确。攻击方式，黑客可以在黑客页面用img标签展示这个验证码，因为验证码url是固定格式的，后面的流程是一样的。你可能的改进方案：</p>
<p>(1)验证码图片做防盗链。黑客破解方案：可以用 Referrer-Policy 的 no-referrer</p>
<p>(2)no-referrer 不给通过。黑客破解方案：可以用 iframe 嵌入你自己的页面，只把你自己页面种的验证码区域展示出来</p>
<p>(3)我的页面不给 iframe 嵌入。黑客说，你成功的防住了</p>
<p>所以需要对验证码做(1)(2)(3)的改造才能防 CSRF 攻击。其实加的(1)(2)(3)措施都不是验证码的本意，验证码是本意用来的防机器攻击的，不加(1)(2)(3)措施也一样可以防机器攻击。这里就有三种观点了。观点一：我只要找到一个反例，找到验证码不能防 CSRF 的一个例子，我就证明了验证码不能防 CSRF。观点二：我只要构造一个能防的例子，对验证码做一系列额外的改造来防 CSRF，我就证明了验证码能防 CSRF。观点三：验证码提高了攻击门槛，攻防就是魔高一丈道高一尺的过程，加上验证码更安全。我个人赞成观点一。读者们你们觉得呢？</p>
<h3 id="3-4-HTTPS-可以么？"><a href="#3-4-HTTPS-可以么？" class="headerlink" title="3.4 HTTPS 可以么？"></a><strong>3.4 HTTPS 可以么？</strong></h3><p>不行，HTTPS 是防中间人攻击的，不是防 CSRF 的</p>
<h3 id="3-5-不用-Cookie-可以么？"><a href="#3-5-不用-Cookie-可以么？" class="headerlink" title="3.5 不用 Cookie 可以么？"></a><strong>3.5</strong> <strong>不用 Cookie 可以么？</strong></h3><p>可以。个人觉得非常不好用，这里讨论两种方案。</p>
<p>方案一：登录态 key 不放在 Cookie。所以 HTTP 请求也不会自动携带 key，也就不存在 CSRF 漏洞，也就不用防了。但是这种设计我个人觉得在一些大型复杂网站是非常棘手难搞的，因为涉及到新开页面，多个页面之间登录态需要同步(其中一个页面退出登录，登录另外账户，或者登录态过期续期等都需要同步给其他页面)，跨页面通讯也有好多方案，如果你使用 localstorage 等本地缓存的话，关闭页面还要清理缓存，缓存满了要清理，浏览器兼容问题等。这种大型系统还会遇到其他的一系列问题，也会有一些列的解决方案，系统会比较复杂，最终还不如用 Cookie 方便。</p>
<p>方案二：登录态 key 放 Cookie。CSRF 的 Token 不放 Cookie，后台生成 Token 藏在 HTML 页面里，后台也存了这个 Token。HTTP 请求通过参数带上这个 Token，后台拿到参数里的 Token 跟自己后台存的 Token 做校验。这个方案也是在一些资料里看到的。但是这个方案也是相当复杂，比如这个方案需要处理好几个关键问题，这个 Token 是有用户属性，要跟用户绑定的。如果 Token 跟用户无关，那么黑客可以用自己账户的 Token 欺骗做水平攻击。另外也有新开页面，多个页面是同一个 Token 还是不同 Token？如果不同 Token，后台需要存一个 Token 列表，列表长度有最大值？另外还有如果其中一个页面退出登录，再登录另外账户。那么其他页面登录态是同步了，但是 Token 如何同步？同样你也会有一些列的解决方案。当你把这些问题都解决了，最后你发现既然 Token 有用户属性，那么就可以当登录态用，就不用 Cookie 的登录态 key 了，又回到了方案一。</p>

  </div>
  <div>
    
      <div 
        class="post-note note-warning copyright" 
        style="margin-top: 42px">
        <p>
          <span style="font-weight: bold;">作者：</span><a 
            target="_blank" 
            rel="nofollow noopener noreferrer" 
            href="/about">
            苞粟玉米
          </a>
        </p>
        <p>
          <span style="font-weight: bold;">文章链接：</span><a 
            target="_blank" 
            rel="nofollow noopener noreferrer" 
            href="https://zhexil.github.io/2022/11/18/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8%E4%B9%8B%20CSRF%20%E6%94%BB%E5%87%BB%E5%8E%9F%E7%90%86%E5%92%8C%E9%98%B2%E6%8A%A4%E6%96%B9%E6%B3%95/">
            https://zhexil.github.io/2022/11/18/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8%E4%B9%8B%20CSRF%20%E6%94%BB%E5%87%BB%E5%8E%9F%E7%90%86%E5%92%8C%E9%98%B2%E6%8A%A4%E6%96%B9%E6%B3%95/
          </a>
        </p>
        <p><span style="font-weight: bold;">版权声明：</span>本博客所有文章除特别声明外，均采用<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0 协议</a>。转载请注明出处！</p>
      </div>
    
  </div>
</article>
<div class="nav">
  
    <div class="nav-item-prev">
      <a 
        href="/2022/11/19/%E5%9B%9E%E5%BF%86%E6%BB%A1%E6%BB%A1%E7%9A%84%E9%AB%98%E7%BA%A7%E6%84%9F%E9%85%8D%E8%89%B2/" 
        class="nav-link">
        <i class="iconfont icon-left nav-prev-icon"></i>
        <div>
          <div class="nav-label">上一篇</div>
          
            <div class="nav-title">回忆满满的高级感配色 </div>
          
        </div>
      </a>
    </div>
  
  
    <div class="nav-item-next">
      <a 
        href="/2022/11/18/hello-world/" 
        class="nav-link">
        <div>
          <div class="nav-label">下一篇</div>
          
            <div class="nav-title">Hello World </div>
          
        </div>
        <i class="iconfont icon-right nav-next-icon"></i>
      </a>
    </div>
  
</div>

<div 
  class="card card-content toc-card" 
  id="mobiletoc">
  <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>目录
</div>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81CSRF-%E6%94%BB%E5%87%BB%E5%8E%9F%E7%90%86"><span class="toc-text">一、CSRF 攻击原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81Cookie-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">1、Cookie 的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81CSRF-%E7%9A%84%E6%94%BB%E5%87%BB%E8%BF%87%E7%A8%8B"><span class="toc-text">2、CSRF 的攻击过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E8%AF%BB%E6%93%8D%E4%BD%9C%E8%83%BD%E5%90%A6%E8%A2%AB%E6%94%BB%E5%87%BB%E5%88%B0%EF%BC%9F"><span class="toc-text">3、读操作能否被攻击到？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81CSRF-%E9%98%B2%E6%8A%A4%E6%96%B9%E6%B3%95"><span class="toc-text">二、CSRF 防护方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81Referrer"><span class="toc-text">1、Referrer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-Referrer-%E4%BC%9A%E4%B8%8D%E4%BC%9A%E8%A2%AB%E4%BC%AA%E9%80%A0%E6%88%96%E8%80%85%E7%AF%A1%E6%94%B9%EF%BC%9F"><span class="toc-text">1.1 Referrer 会不会被伪造或者篡改？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E7%94%A8-Referrer-%E9%98%B2-CSRF-%E5%AE%89%E5%85%A8%E4%B9%88%EF%BC%9F"><span class="toc-text">1.2 用 Referrer 防 CSRF 安全么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E7%94%A8-Origin-%E5%8F%AF%E4%BB%A5%E4%B9%88%EF%BC%9F"><span class="toc-text">1.3 用 Origin 可以么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E6%97%A2%E7%84%B6%E8%83%BD%E5%81%9A%E5%88%B0%E5%AE%89%E5%85%A8%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E7%8E%B0%E5%9C%A8%E5%BE%88%E5%B0%91%E8%A7%81%E7%94%A8%E8%BF%99%E7%A7%8D%E6%96%B9%E6%A1%88%EF%BC%9F"><span class="toc-text">1.4 既然能做到安全，为什么现在很少见用这种方案？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81Token"><span class="toc-text">2、Token</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Token-%E6%98%AF%E5%89%8D%E5%8F%B0%E7%94%9F%E4%BA%A7%E8%BF%98%E6%98%AF%E5%90%8E%E5%8F%B0%E7%94%9F%E4%BA%A7%EF%BC%9F"><span class="toc-text">2.1 Token 是前台生产还是后台生产？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%8E%A8%E8%8D%90%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%96%B9%E6%A1%88"><span class="toc-text">2.2 推荐的最佳实践方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-Token-%E6%94%BE%E5%9C%A8-HTTP-%E5%8F%82%E6%95%B0%E9%87%8C%E7%9A%84%E5%93%AA%E9%87%8C%EF%BC%9F"><span class="toc-text">2.3 Token 放在 HTTP 参数里的哪里？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E7%94%A8-Token-%E6%96%B9%E6%A1%88%E5%90%8E%E5%86%99%E6%93%8D%E4%BD%9C%E5%8F%AF%E4%BB%A5%E7%94%A8-Get-%E4%B9%88%EF%BC%9F"><span class="toc-text">2.4 用 Token 方案后写操作可以用 Get 么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E7%94%A8-Token-%E6%96%B9%E6%A1%88%E5%90%8E%E8%AF%BB%E6%93%8D%E4%BD%9C%E5%8F%AF%E4%BB%A5%E7%94%A8-JSONP-%E8%B7%A8%E5%9F%9F%E4%B9%88%EF%BC%9F"><span class="toc-text">2.5 用 Token 方案后读操作可以用 JSONP 跨域么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-%E5%A6%82%E6%9E%9C%E9%A1%B5%E9%9D%A2%E6%9C%89-XSS-%E6%BC%8F%E6%B4%9E%EF%BC%8C%E9%BB%91%E5%AE%A2%E6%8B%BF%E5%88%B0-Cookie-%E6%80%8E%E4%B9%88%E5%8A%9E%EF%BC%9F"><span class="toc-text">2.6 如果页面有 XSS 漏洞，黑客拿到 Cookie 怎么办？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%98%AF%E5%90%A6%E8%BF%98%E6%9C%89%E5%85%B6%E4%BB%96%E6%96%B9%E6%A1%88"><span class="toc-text">3、是否还有其他方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Cookie-%E7%9A%84-SameSite-%E5%B1%9E%E6%80%A7%E5%8F%AF%E4%BB%A5%E4%B9%88%EF%BC%9F"><span class="toc-text">3.1 Cookie 的 SameSite 属性可以么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Cookie-%E7%9A%84-HTTPOnly-%E5%B1%9E%E6%80%A7%E5%8F%AF%E4%BB%A5%E4%B9%88%EF%BC%9F"><span class="toc-text">3.2 Cookie 的 HTTPOnly 属性可以么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E9%AA%8C%E8%AF%81%E7%A0%81%E5%8F%AF%E4%BB%A5%E4%B9%88%EF%BC%9F"><span class="toc-text">3.3 验证码可以么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-HTTPS-%E5%8F%AF%E4%BB%A5%E4%B9%88%EF%BC%9F"><span class="toc-text">3.4 HTTPS 可以么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E4%B8%8D%E7%94%A8-Cookie-%E5%8F%AF%E4%BB%A5%E4%B9%88%EF%BC%9F"><span class="toc-text">3.5 不用 Cookie 可以么？</span></a></li></ol></li></ol>
</div>
            </main>
            <aside class="right-column">
              <div class="sticky-widescreen">
  
  
    <article class="card card-content toc-card">
      <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>目录
</div>
<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81CSRF-%E6%94%BB%E5%87%BB%E5%8E%9F%E7%90%86"><span class="toc-text">一、CSRF 攻击原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81Cookie-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">1、Cookie 的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81CSRF-%E7%9A%84%E6%94%BB%E5%87%BB%E8%BF%87%E7%A8%8B"><span class="toc-text">2、CSRF 的攻击过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E8%AF%BB%E6%93%8D%E4%BD%9C%E8%83%BD%E5%90%A6%E8%A2%AB%E6%94%BB%E5%87%BB%E5%88%B0%EF%BC%9F"><span class="toc-text">3、读操作能否被攻击到？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81CSRF-%E9%98%B2%E6%8A%A4%E6%96%B9%E6%B3%95"><span class="toc-text">二、CSRF 防护方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81Referrer"><span class="toc-text">1、Referrer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-Referrer-%E4%BC%9A%E4%B8%8D%E4%BC%9A%E8%A2%AB%E4%BC%AA%E9%80%A0%E6%88%96%E8%80%85%E7%AF%A1%E6%94%B9%EF%BC%9F"><span class="toc-text">1.1 Referrer 会不会被伪造或者篡改？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E7%94%A8-Referrer-%E9%98%B2-CSRF-%E5%AE%89%E5%85%A8%E4%B9%88%EF%BC%9F"><span class="toc-text">1.2 用 Referrer 防 CSRF 安全么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E7%94%A8-Origin-%E5%8F%AF%E4%BB%A5%E4%B9%88%EF%BC%9F"><span class="toc-text">1.3 用 Origin 可以么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E6%97%A2%E7%84%B6%E8%83%BD%E5%81%9A%E5%88%B0%E5%AE%89%E5%85%A8%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E7%8E%B0%E5%9C%A8%E5%BE%88%E5%B0%91%E8%A7%81%E7%94%A8%E8%BF%99%E7%A7%8D%E6%96%B9%E6%A1%88%EF%BC%9F"><span class="toc-text">1.4 既然能做到安全，为什么现在很少见用这种方案？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81Token"><span class="toc-text">2、Token</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Token-%E6%98%AF%E5%89%8D%E5%8F%B0%E7%94%9F%E4%BA%A7%E8%BF%98%E6%98%AF%E5%90%8E%E5%8F%B0%E7%94%9F%E4%BA%A7%EF%BC%9F"><span class="toc-text">2.1 Token 是前台生产还是后台生产？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%8E%A8%E8%8D%90%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%96%B9%E6%A1%88"><span class="toc-text">2.2 推荐的最佳实践方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-Token-%E6%94%BE%E5%9C%A8-HTTP-%E5%8F%82%E6%95%B0%E9%87%8C%E7%9A%84%E5%93%AA%E9%87%8C%EF%BC%9F"><span class="toc-text">2.3 Token 放在 HTTP 参数里的哪里？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E7%94%A8-Token-%E6%96%B9%E6%A1%88%E5%90%8E%E5%86%99%E6%93%8D%E4%BD%9C%E5%8F%AF%E4%BB%A5%E7%94%A8-Get-%E4%B9%88%EF%BC%9F"><span class="toc-text">2.4 用 Token 方案后写操作可以用 Get 么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E7%94%A8-Token-%E6%96%B9%E6%A1%88%E5%90%8E%E8%AF%BB%E6%93%8D%E4%BD%9C%E5%8F%AF%E4%BB%A5%E7%94%A8-JSONP-%E8%B7%A8%E5%9F%9F%E4%B9%88%EF%BC%9F"><span class="toc-text">2.5 用 Token 方案后读操作可以用 JSONP 跨域么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-%E5%A6%82%E6%9E%9C%E9%A1%B5%E9%9D%A2%E6%9C%89-XSS-%E6%BC%8F%E6%B4%9E%EF%BC%8C%E9%BB%91%E5%AE%A2%E6%8B%BF%E5%88%B0-Cookie-%E6%80%8E%E4%B9%88%E5%8A%9E%EF%BC%9F"><span class="toc-text">2.6 如果页面有 XSS 漏洞，黑客拿到 Cookie 怎么办？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%98%AF%E5%90%A6%E8%BF%98%E6%9C%89%E5%85%B6%E4%BB%96%E6%96%B9%E6%A1%88"><span class="toc-text">3、是否还有其他方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Cookie-%E7%9A%84-SameSite-%E5%B1%9E%E6%80%A7%E5%8F%AF%E4%BB%A5%E4%B9%88%EF%BC%9F"><span class="toc-text">3.1 Cookie 的 SameSite 属性可以么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Cookie-%E7%9A%84-HTTPOnly-%E5%B1%9E%E6%80%A7%E5%8F%AF%E4%BB%A5%E4%B9%88%EF%BC%9F"><span class="toc-text">3.2 Cookie 的 HTTPOnly 属性可以么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E9%AA%8C%E8%AF%81%E7%A0%81%E5%8F%AF%E4%BB%A5%E4%B9%88%EF%BC%9F"><span class="toc-text">3.3 验证码可以么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-HTTPS-%E5%8F%AF%E4%BB%A5%E4%B9%88%EF%BC%9F"><span class="toc-text">3.4 HTTPS 可以么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E4%B8%8D%E7%94%A8-Cookie-%E5%8F%AF%E4%BB%A5%E4%B9%88%EF%BC%9F"><span class="toc-text">3.5 不用 Cookie 可以么？</span></a></li></ol></li></ol>
    </article>
  
  
  <article class="card card-content">
    <div class="recent-posts-card">
  <div class="recent-posts-header">
    <i 
      class="iconfont icon-wenzhang_huaban" 
      style="padding-right: 2px;">
    </i>最近文章
  </div>
  <div class="recent-posts-list">
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2022-11-19</div>
        <a href="/2022/11/19/%E4%BC%A0%E7%BB%9F%E9%A2%9C%E8%89%B2%E7%BD%91%E7%AB%99/"><div class="recent-posts-item-content">传统颜色网站</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2022-11-19</div>
        <a href="/2022/11/19/%E9%AB%98%E7%BA%A7%E6%84%9F%E5%8F%8C%E8%89%B2%E6%90%AD%E9%85%8D/"><div class="recent-posts-item-content">高级感双色搭配</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2022-11-19</div>
        <a href="/2022/11/19/Hexo%E6%8F%92%E5%85%A5%E5%9B%BE%E7%89%87%E5%8F%8A%E6%8E%A7%E5%88%B6%E5%A4%A7%E5%B0%8F/"><div class="recent-posts-item-content">Hexo插入图片及图片无法显示的解决办法</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2022-11-19</div>
        <a href="/2022/11/19/%E5%9B%9E%E5%BF%86%E6%BB%A1%E6%BB%A1%E7%9A%84%E9%AB%98%E7%BA%A7%E6%84%9F%E9%85%8D%E8%89%B2/"><div class="recent-posts-item-content">回忆满满的高级感配色</div></a>
      </div>
    
  </div>
</div>
  </article>
  
  
</div>
            </aside>
          </div>
        </div>
      </div>
    </div>
     
    <footer class="footer">
  <div class="footer-container">
    <div>
      <div class="footer-dsc">
        <span>
          Copyright ©
          
            2022
          
          
        </span>
        &nbsp;
        <a 
          href="/" 
          class="footer-link">
          苞粟|玉米的博客
        </a>
      </div>
    </div>

    
      <div class="footer-dsc">
        
          Powered by
          <a 
            href="https://hexo.io/" 
            class="footer-link" 
            target="_blank" 
            rel="nofollow noopener noreferrer">
            &nbsp;Hexo
          </a>
        
        
          <span>&nbsp;|&nbsp;</span>
        
        
          Theme -
          <a 
            href="https://github.com/theme-kaze" 
            class="footer-link" 
            target="_blank"
            rel="nofollow noopener noreferrer">
            &nbsp;Kaze
          </a>
        
      </div>
    
    
    
    
</footer>
 
    
  <a 
    role="button" 
    id="scrollbutton" 
    class="basebutton" 
    aria-label="回到顶部">
    <i class="iconfont icon-arrowleft button-icon"></i>
  </a>

<a 
  role="button" 
  id="menubutton"
  aria-label="menu button"
  class="basebutton">
  <i class="iconfont icon-menu button-icon"></i>
</a>
<a 
  role="button" 
  id="popbutton" 
  class="basebutton" 
  aria-label="控制中心">
  <i class="iconfont icon-expand button-icon"></i>
</a>
<a 
  role="button" 
  id="darkbutton" 
  class="basebutton darkwidget" 
  aria-label="夜色模式">
  <i class="iconfont icon-weather button-icon"></i>
</a>
<a 
  role="button" 
  id="searchbutton" 
  class="basebutton searchwidget" 
  aria-label="搜索">
  <i class="iconfont icon-search button-icon"></i>
</a> 
     
     
      
 
     
     
      <script>
  var addImgLayout = function () {
    var img = document.querySelectorAll('.post-content img')
    var i
    for (i = 0; i < img.length; i++) {
      var wrapper = document.createElement('a')
      wrapper.setAttribute('href', img[i].getAttribute('data-src'))
      wrapper.setAttribute('aria-label', 'illustration')
      wrapper.style.cssText =
        'width: 100%; display: flex; justify-content: center;'
      if (img[i].alt) wrapper.dataset.caption = img[i].alt
      wrapper.dataset.nolink = true
      img[i].before(wrapper)
      wrapper.append(img[i])
      var divWrap = document.createElement('div')
      divWrap.classList.add('gallery')
      wrapper.before(divWrap)
      divWrap.append(wrapper)
    }
    baguetteBox.run('.gallery')
  }
</script>
<script>
  loadScript(
    "/js/lib/lightbox/baguetteBox.min.js",
    addImgLayout
  )
</script>
 
     
     
    <script src="/js/main.js"></script> 
     
    
      <script>
        var addLazyload = function () {
          var observer = lozad('.lozad', {
            load: function (el) {
              el.srcset = el.getAttribute('data-src')
            },
            loaded: function (el) {
              el.classList.add('loaded')
            },
          })
          observer.observe()
        }
      </script>
      <script>
        loadScript('/js/lib/lozad.min.js', addLazyload)
      </script>
    
    <script src="//instant.page/5.1.0" type="module"
      integrity="sha384-by67kQnR+pyfy8yWP4kPO12fHKRLHZPfEsiSXR8u2IKcTdxD805MGUXBzVPnkLHw"></script>
    
    
      <script>
        setTimeout(() => {localSearch("search.json")}, 0)
      </script>
    
  </body>
</html>
